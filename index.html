<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <title>dbmigrations by jhgbrt</title>
  </head>

  <body>

    <header>
      <div class="container">
        <h1>dbmigrations</h1>
        <h2>A utility for managing database migration scripts</h2>

        <section id="downloads">
          <a href="https://github.com/jhgbrt/DbMigrations/zipball/master" class="btn">Download as .zip</a>
          <a href="https://github.com/jhgbrt/DbMigrations/tarball/master" class="btn">Download as .tar.gz</a>
          <a href="https://github.com/jhgbrt/DbMigrations" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <p><a href="https://ci.appveyor.com/project/jhgbrt/dbmigrations"><img src="https://ci.appveyor.com/api/projects/status/9y7tm6ujwg6d05kv?svg=true" alt="Build status"></a></p>

<h1>
<a id="dbmigrations" class="anchor" href="#dbmigrations" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>DbMigrations</h1>

<p>Use this utility to execute DDL and SQL scripts against a database</p>

<h2>
<a id="how-it-works" class="anchor" href="#how-it-works" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How it works</h2>

<p>The tool is a command-line utility that you point at a folder containing
sql scripts, which (by convention) need to be organized in a certain way.
Here's a small example to get a feel of it:</p>

<pre><code>migrate.exe --directory=path/to/scripts --server=.\sqlexpress --database=MyDb
</code></pre>

<p>This command runs all migration scripts in the folder pointed to against a
SQL Express database, using integrated security. </p>

<h2>
<a id="organizing-the-scripts" class="anchor" href="#organizing-the-scripts" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Organizing the scripts</h2>

<p>By default, first all scripts in a folder called 'Migrations'
will be executed (in strict alphabetical order). Scripts may be
organized in subfolders, in which case the folders will also be
treated in alphabetical order. However, once a migration script
has been performed from a 'newer' folder, it is not allowed to
add new migrations in an 'earlier' folder.</p>

<h2>
<a id="tracking-the-migrations" class="anchor" href="#tracking-the-migrations" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Tracking the migrations</h2>

<p>Migrations are tracked inside the database, in a table called 'Migrations'.
Once a migration has been performed, it can not be changed. Also, new
versions of a migration package should always include all previous
migrations, with the same name in the same order.</p>

<p>The Migrations table has the following layout (note that the exact data type
depends on the database on which the migrations are run):</p>

<pre><code>ScriptName (string): the name of the script (relative to the Migrations folder)
Checksum   (string): a MD5 hash of the script content
Content    (string): the full content of the script
ExecutedOn (date)  : the (local) date/time when this script was executed
</code></pre>

<h2>
<a id="additional-idempotent-scripts" class="anchor" href="#additional-idempotent-scripts" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Additional (idempotent) scripts</h2>

<p>For added convenience, the tool also supports running additional sql
scripts, in addition to the migration scripts themselfves.</p>

<p>After the migrations have been run, by default <em>all</em> scripts in <em>all</em> other
subfolders are executed. These scripts can be data loads, updates of
views or stored procedures, etc. The only limitation is that these
scripts should be <strong>idempotent</strong> at all times, and consistent with the
current state of the database as it is represented by the set of
migrations.</p>

<p>It is possible fine-tune this behaviour and have a pre-migration phase as well, using the
-pre and -post switches, where you specify a comma-seperated list of folders that must
be executed before resp. after the migrations. It is <em>highly</em> recommended to only
include 'generic', idem-potent scripts in the pre-migration phase, otherwise this folder
will very quickly become a source of severe headaches.</p>

<h2>
<a id="example" class="anchor" href="#example" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Example</h2>

<p>Given this folder structure:</p>

<pre><code>Scripts
├───01_DataLoads
|   ├───01_Phase1
|   |   ├───001_referencedata1.sql
|   |   └───002_samples.sql
|   └───02_Phase2
|       └───001_referencedata2.sql
├───02_ViewsAndSprocs
|   ├───001_views.sql
|   └───002_sprocs.sql
└───Migrations
    ├───001_migration1.sql
    └───002_migration2.sql
</code></pre>

<p>The scripts in this structure will be run in this order:</p>

<pre><code>Scripts\Migrations\001_migration1.sql
Scripts\Migrations\002_migration2.sql
Scripts\01_DataLoads\01_Phase1\001_referencedata1.sql
Scripts\01_DataLoads\01_Phase1\002_samples.sql
Scripts\01_DataLoads\02_Phase2\002_referencedata2.sql
Scripts\02_ViewsAndSprocs\001_views.sql
Scripts\02_ViewsAndSprocs\002_sprocs.sql
</code></pre>

<h2>
<a id="command-line-options" class="anchor" href="#command-line-options" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Command line options</h2>

<pre><code>  --server=VALUE         
</code></pre>

<p>The db server. For SQL Server, this is a string
                               of the form 'servername\instance' (e.g.
                               localhost\sqlexpress), or just 'servername' in
                               case there's just a default instance). For
                               Oracle, you can use either a registered TNS
                               name, or (using the EZCONNECT feature), use a
                               string of the form 'server[:port[/service]]', e.
                               g. 'localhost:1521/XE'</p>

<pre><code>  --user=VALUE           
</code></pre>

<p>The database username (when no user/password specified,
                               integrated security is assumed)</p>

<pre><code>  --password=VALUE       
</code></pre>

<p>The database password (when no user/password specified,
                               integrated security is assumed)</p>

<pre><code>  --database=VALUE       
</code></pre>

<p>The database name (initial catalog)</p>

<pre><code>  --directory=VALUE      
</code></pre>

<p>Absolute or relative path to folder containing the migration scripts</p>

<pre><code>  --whatif               
</code></pre>

<p>Do not actually run the scripts, just report what
                               would be executed).</p>

<pre><code>  --help                 
</code></pre>

<p>Print help</p>

<pre><code>  --connectionString=VALUE
</code></pre>

<p>The complete connection string</p>

<pre><code>  --providerName=VALUE   
</code></pre>

<p>The database provider invariant name. The default
                               is System.Data.SqlClient). For other provider
                               names, the corresponding .dll containing the
                               provider implementation must be deployed
                               alongside the migration utility (e.g., for
                               Oracle: Oracle.ManagedDataAccess.Client.dll).</p>

<pre><code>  --schema=VALUE         
</code></pre>

<p>Db schema for Migrations table (if different from the default for this user). 
For Sql server, the default schema is "dbo". For Oracle, the default schema 
is the same as the user name.</p>

<pre><code>  --reinitialize         
</code></pre>

<p>Will clear the database and re-run all migrations.
                                Unless --force is specified, this is only
                               allowed for local databases. Use with care!</p>

<pre><code>  --force                
</code></pre>

<p>When used with --reinitialize, allows to restage
                               a remote db. Use with care!</p>

<h2>
<a id="additional-examples" class="anchor" href="#additional-examples" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Additional examples</h2>

<pre><code>migrate.exe --directory=path/to/scripts --reinitialize \
            --server=localhost:1521/XE --user=(user) --password=(pass) \
            --schema=MYSCHEMA
            --providerName=Oracle.ManagedDataAccess.Client 
</code></pre>

<p>Drops all user objects and re-runs the migrations in the given folder against the 
schema MYSCHEMA of a locally installed Oracle XE instance. The user must exist, and 
have been granted sufficient rights in that schema.</p>

<pre><code>migrate.exe --directory=path/to/scripts --server=mydbserver --database=MyDb
</code></pre>

<p>(Incrementally) runs all migrations in the given directory against the default 
instance running on server mydbserver. Integrated Security is used, so the user 
under which the command is run should have sufficient rights. </p>
      </section>
    </div>

    
  </body>
</html>
